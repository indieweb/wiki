https://indieweb.org/mediawiki-customization

This page documents the customizations we've made to MediaWiki for our community.

== extensions ==
=== IndieWeb extensions ===
https://github.com/indieweb/mediawiki-extensions

* AllowAnchorTags - allows inserting <code><a></code> anchor tags into wikitext
* notitle - adds <code><nowiki>__NOTITLE__</nowiki></code> tag to stop MediaWiki from adding its own page title
* raw - lets you embed raw HTML into wiki pages using <nowiki>raw</nowiki>
* RelWebmention - add webmention endpoint to wiki pages
* LassoAuth - enables [[web sign-in]] via the [[Lasso]] auth proxy
* Calendar - adds <nowiki><calendar></nowiki> tag for creation of a single month calendar

=== dfn ===
https://github.com/aaronpk/mediawiki-mf2-dfn

Adds a <code>p-summary</code> tag around the first sentence of a page that contains a <code><nowiki><dfn></nowiki></code> tag

=== CategoryTree ===
* https://www.mediawiki.org/wiki/Extension:CategoryTree

=== mf2 parser ===
The wiki requires a Microformats parser to be able to do a few things. Copy the [https://github.com/indieweb/php-mf2 php-mf2] repository to the extensions folder.

=== enable extensions ===
<pre>wfLoadExtension('Cite');
wfLoadExtension('ParserFunctions');
wfLoadExtension('Auth_remoteuser');
wfLoadExtension('CategoryTree');

require_once('extensions/php-mf2/Mf2/Parser.php');
require_once('extensions/dfn/dfn.php');

require_once('extensions/IndieWeb/raw.php');
require_once('extensions/IndieWeb/notitle.php');
require_once('extensions/IndieWeb/AllowAnchorTags.php');
require_once('extensions/IndieWeb/RelWebmention.php');
require_once('extensions/IndieWeb/Calendar.php');
require_once('extensions/IndieWeb/LassoAuth.php');
</pre>

=== extension config ===
<pre>LassoAuth::$auth = 'https://sso.indieweb.org/';
LassoAuth::$wiki = 'https://indieweb.org/';

$wgPingbackEndpoint = 'https://webmention.io/indiewebcamp/xmlrpc';
$wgWebmentionEndpoint = 'https://webmention.io/indiewebcamp/webmention';</pre>

== editable customizations ==

See [[MediaWiki:Common.css]] for custom CSS used on this wiki.

== configuration ==
Add these to <code>LocalSettings.php</code>

=== enable nice urls ===
The wiki is installed in the <code>wiki</code> folder on the server, but we want the URLs to be <code>indieweb.org/example</code>.

<pre>$wgScriptPath = '/wiki';
$wgScriptExtension  = ".php";
$wgArticlePath = '/$1';
$wgUsePathInfo = true;
$wgCapitalLinks = false;</pre>

=== user permissions ===
<pre>$wgGroupPermissions['*']['read'] = true;
$wgGroupPermissions['*']['edit'] = false;
$wgGroupPermissions['*']['createaccount'] = false;
$wgGroupPermissions['*']['autocreateaccount'] = true;
$wgGroupPermissions['user']['move'] = true;
$wgGroupPermissions['user']['movefile'] = true;
$wgGroupPermissions['user']['delete'] = true;
$wgGroupPermissions['user']['undelete'] = true;
$wgGroupPermissions['user']['browsearchive'] = true;
$wgGroupPermissions['user']['rollback'] = true;
$wgDefaultUserOptions ['editsection'] = true;
$wgAllowUserSkin = true;
$wgAllowUserCss = true;
$wgAllowUserJs = true;</pre>

=== copyright ===
<pre>$wgEnableCreativeCommonsRdf = true;
$wgRightsPage = "IndieWebCamp:Copyrights"; # Set to the title of a wiki page that describes your license/copyright
$wgRightsUrl = "http://creativecommons.org/publicdomain/zero/1.0/";
$wgRightsText = "a CC0 public domain dedication";
$wgRightsIcon = "https://i.creativecommons.org/p/zero/1.0/88x31.png";
$wgEnableCreativeCommonsRdf = true;</pre>

=== allow more file uploads ===
<pre>$wgFileExtensions[] = 'pdf';
$wgFileExtensions[] = 'txt';
$wgFileExtensions[] = 'svg';
$wgFileExtensions[] = 'ai';</pre>

=== others ===
<pre>$wgEnableUploads = true;
$wgAllowImageTag = true;
$wgNoFollowLinks = false;
$wgAllowExternalImages = true;
$wgCookieExpiration = 180 * 86400;
$wgSecureLogin = true;
$wgCookieSecure = true;</pre>

== skin ==
We use the default Vector skin for the wiki, with some minor customization to add Microformats markup to pages.

In <code>skins/Vector/VectorTemplate.php</code>, make the changes described on https://aaronparecki.com/2018/01/14/3/

== front page ==
MediaWiki refuses to serve the front page from <code>/</code> and insists on redirecting it to <code>/Main_Page</code> instead. It's possible to rename that page to something like <code>/Home</code>, but even that isn't great. We want the front page to be served at just <code>https://indieweb.org/</code>. To do that, there is a separate <code>index.php</code> file at the root of the server, which essentially proxies the MediaWiki page.

<pre><?php
$opts = array('title' => 'Main_Page');
if(array_key_exists('useskin',$_GET))
  $opts['useskin'] = $_GET['useskin'];
$ch = curl_init('https://indieweb.org/wiki/index.php?'.http_build_query($opts));
// Pass the HTTP_COOKIE header through for auth
if(array_key_exists('HTTP_COOKIE', $_SERVER)) {
	curl_setopt($ch, CURLOPT_HTTPHEADER, array(
		'Cookie: ' . $_SERVER['HTTP_COOKIE']
	));
}

header('Link: <https://webmention.io/indiewebcamp/webmention>; rel="webmention"');

// No-cache if the user is logged in
if(isset($_SERVER['REMOTE_USER'])) {
  header('Cache-Control: no-cache');
}

curl_exec($ch);</pre>


== See Also ==
* [[wiki/]]
* [http://microformats.org/wiki microformats wiki]:
** [http://microformats.org/wiki/mediawiki-customization microformats wiki mediawiki customization] - you might find some useful customizations here too.
